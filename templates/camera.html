<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Camera</title>
	<style>
		body {
			font-family: Arial, sans-serif;
			display: flex;
			justify-content: center;
			align-items: center;
			height: 100vh;
			margin: 0;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
		}

		.container {
			text-align: center;
			background: white;
			padding: 20px;
			border-radius: 10px;
			box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
			width: 90%;
			max-width: 800px;
			display: flex;
			flex-direction: column;
		}

		h1 {
			color: #333;
			margin-top: 0;
			margin-bottom: 20px;
		}

		video {
			width: 100%;
			height: auto;
			border-radius: 5px;
			background-color: #000;
		}

		.textbar {
			margin-top: 20px;
			padding: 15px;
			background-color: #f0f0f0;
			border-radius: 5px;
			font-size: 1.1em;
			color: #333;
			font-weight: bold;
		}

		button {
			margin-top: 10px;
			padding: 10px 20px;
			font-size: 1em;
			background-color: #667eea;
			color: white;
			border: none;
			border-radius: 5px;
			cursor: pointer;
			transition: background-color 0.3s;
		}

		button:hover {
			background-color: #764ba2;
		}
	</style>
</head>

<body>
	<div class="container">
		<h1>Webcam</h1>
		<video id="webcam" playsinline autoplay muted></video>
		<canvas id="canvas" style="display:none;"></canvas>
		<button onclick="toggleCamera()">Toggle Camera</button>
		<div class="textbar">camera</div>
	</div>

	<script>
		let stream = null;
		const video = document.getElementById('webcam');
		const canvas = document.getElementById('canvas');
		const ctx = canvas.getContext('2d');
		let frameIntervalId = null;

		async function startCamera() {
			try {
				console.log('Requesting camera access...');
				const constraints = {
					video: {
						width: { ideal: 1280 },
						height: { ideal: 720 }
					},
					audio: false
				};

				stream = await navigator.mediaDevices.getUserMedia(constraints);
				console.log('Camera access granted, stream obtained');

				video.srcObject = stream;

				// Ensure video plays
				video.onloadedmetadata = () => {
					console.log('Video metadata loaded');
					video.play().catch(err => console.error('Play error:', err));
					// Start capturing frames
					startCapturingFrames();
				};

				console.log('Camera started successfully');
			} catch (error) {
				console.error('Error accessing camera:', error);
				console.error('Error name:', error.name);
				console.error('Error message:', error.message);
				alert('Could not access webcam: ' + error.message);
			}
		}

		function stopCamera() {
			if (frameIntervalId) {
				clearInterval(frameIntervalId);
				frameIntervalId = null;
			}
			if (stream) {
				stream.getTracks().forEach(track => {
					console.log('Stopping track:', track.kind);
					track.stop();
				});
				stream = null;
			}
		}

		function startCapturingFrames() {
			// Capture frames at ~15 FPS
			frameIntervalId = setInterval(() => {
				if (video.readyState === video.HAVE_ENOUGH_DATA) {
					// Set canvas size to match video
					canvas.width = video.videoWidth;
					canvas.height = video.videoHeight;

					// Draw current frame to canvas
					ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

					// Convert canvas to blob and send to server
					canvas.toBlob(blob => {
						const formData = new FormData();
						formData.append('frame', blob, 'frame.jpg');

						fetch('/upload_frame', {
							method: 'POST',
							body: formData
						}).catch(err => console.error('Error sending frame:', err));
					}, 'image/jpeg', 0.8);
				}
			}, 67); // ~15 FPS (1000ms / 15 = 67ms)
		}

		function toggleCamera() {
			if (stream) {
				stopCamera();
			} else {
				startCamera();
			}
		}

		// Start camera on page load
		console.log('Page loading, adding event listeners');
		window.addEventListener('load', () => {
			console.log('Load event fired, starting camera');
			startCamera();
		});

		// Stop camera when leaving page
		window.addEventListener('beforeunload', stopCamera);
	</script>
</body>

</html>
